!-----------------------------------------------------------------------------
! (c) Crown copyright 2025 Met Office. All rights reserved.
! The file LICENCE, distributed with this code, contains details of the terms
! under which the code may be used.
!-----------------------------------------------------------------------------

!> @brief Test the kernel that computes the linear vertical SL coefficients

module compute_vertical_linear_coef_kernel_mod_test

  use constants_mod,                  only: i_def, l_def, r_tran

  implicit none

contains

  !------------------------------------------------------------------

  @test
  subroutine compute_vertical_linear_coef_kernel_test()
    use funit
    use, intrinsic :: iso_fortran_env,  only: real64
    use compute_vertical_linear_coef_kernel_mod,        only: compute_vertical_linear_coef_code

    implicit none

    real(kind=r_tran) :: tol
    integer(kind=i_def), parameter :: nlayers = 5
    integer(kind=i_def), parameter :: ndf_wt = 2
    integer(kind=i_def), parameter :: undf_wt  = (ndf_wt-1)*nlayers+1
    integer(kind=i_def), parameter :: ndf_w2v = 2
    integer(kind=i_def), parameter :: undf_w2v  = (ndf_w2v-1)*nlayers+1
    integer(kind=i_def), parameter :: ndf_wc = 1
    integer(kind=i_def), parameter :: undf_wc  = nlayers
    integer(kind=i_def), parameter :: ndf_wm = 2
    integer(kind=i_def), parameter :: undf_wm  = nlayers+1

    integer(kind=i_def), dimension(ndf_wt)  :: map_wt
    integer(kind=i_def), dimension(ndf_w2v) :: map_w2v
    integer(kind=i_def), dimension(ndf_wc)  :: map_wc
    integer(kind=i_def), dimension(ndf_wm)  :: map_wm

    real(kind=r_tran),   dimension(undf_w2v) :: dep_pts_z
    real(kind=r_tran),   dimension(undf_wt)  :: theta_height
    real(kind=r_tran),   dimension(undf_wc)  :: linear_coef_w3_1, linear_coef_w3_2
    real(kind=r_tran),   dimension(undf_wm)  :: linear_coef_wt_1, linear_coef_wt_2

    ! Set tolerance
    if ( r_tran == real64 ) then
      tol = 1.0e-12_r_tran
    else
      tol = 1.0e-6_r_tran
    end if

    ! Set maps
    map_w2v(1) = 1
    map_w2v(2) = 2
    map_wt(1) = 1
    map_wt(2) = 2
    map_wc(1) = 1
    map_wm(1) = 1
    map_wm(2) = 2

    ! Set up data
    theta_height = (/0.0_r_tran, 1.0_r_tran, 2.0_r_tran, 3.0_r_tran, 4.0_r_tran, 5.0_r_tran /)
    dep_pts_z    = (/0.0_r_tran, 0.0_r_tran, 0.5_r_tran, 1.2_r_tran, -0.1_r_tran, 0.0_r_tran /)

    ! Test with W3 coefficients
    call compute_vertical_linear_coef_code( nlayers,                           &
                                            dep_pts_z,                         &
                                            theta_height,                      &
                                            linear_coef_w3_1,                  &
                                            linear_coef_w3_2,                  &
                                            ndf_w2v, undf_w2v, map_w2v,        &
                                            ndf_wt, undf_wt, map_wt,           &
                                            ndf_wc, undf_wc, map_wc )

    ! Test selection of the W3 linear coefficients (coefficients are also tested in sl_support_mod_test)
    @assertEqual(1.0_r_tran, linear_coef_w3_1(1), tol)
    @assertEqual(0.15_r_tran, linear_coef_w3_2(3), tol)

    ! Get Wtheta coefficients
    call compute_vertical_linear_coef_code( nlayers,                           &
                                            dep_pts_z,                         &
                                            theta_height,                      &
                                            linear_coef_wt_1,                  &
                                            linear_coef_wt_2,                  &
                                            ndf_w2v, undf_w2v, map_w2v,        &
                                            ndf_wt, undf_wt, map_wt,           &
                                            ndf_wm, undf_wm, map_wm )

    ! Test selection of the Wtheta linear coefficients (coefficients are also tested in sl_support_mod_test)
    @assertEqual(1.0_r_tran, linear_coef_wt_1(1), tol)
    @assertEqual(0.8_r_tran, linear_coef_wt_2(4), tol)

  end subroutine compute_vertical_linear_coef_kernel_test

end module compute_vertical_linear_coef_kernel_mod_test