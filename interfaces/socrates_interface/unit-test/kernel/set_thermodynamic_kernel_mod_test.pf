!-----------------------------------------------------------------------------
! (C) Crown copyright 2022 Met Office. All rights reserved.
! The file LICENCE, distributed with this code, contains details of the terms
! under which the code may be used.
!-----------------------------------------------------------------------------
!> Test the Socrates thermodynamic kernel
!>
module set_thermodynamic_kernel_mod_test

  use funit
  use constants_mod,                       only : r_def, i_def
  use get_unit_test_m3x3_dofmap_mod,       only : get_wtheta_m3x3_dofmap, &
                                                  get_w3_m3x3_dofmap
  use get_unit_test_m3x3_q3x3x3_sizes_mod, only : get_w3_m3x3_q3x3x3_size, &
                                                  get_wtheta_m3x3_q3x3x3_size

  implicit none

contains

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  @test
  subroutine test_set_thermodynamic()

    use set_thermodynamic_kernel_mod, only: set_thermodynamic_code

    implicit none

    ! Input constants
    real(r_def), parameter :: gravity  = 9.80665_r_def
    real(r_def), parameter :: p_zero   = 100000.0_r_def
    real(r_def), parameter :: cp       = 1005.0_r_def
    real(r_def), parameter :: rd       = 287.05_r_def
    real(r_def), parameter :: kappa    = rd/cp

    ! Dofmap, cell numbers and layers
    integer(i_def) :: nlayers
    integer(i_def) :: ndf_w3, ndf_wtheta, ndf_flux
    integer(i_def) :: undf_w3, undf_wtheta, undf_flux
    integer(i_def) :: cells_w3, cells_wtheta, cells_flux
    integer(i_def) :: dim_space_w3, dim_space_wtheta, dim_space_flux
    integer(i_def) :: dim_space_diff_w3, dim_space_diff_wtheta, dim_space_diff_flux
    integer(i_def) :: nqp_h_w3, nqp_h_wtheta, nqp_h_flux
    integer(i_def) :: nqp_v_w3, nqp_v_wtheta, nqp_v_flux
    integer(i_def), allocatable :: map_w3(:,:), map_wtheta(:,:), map_flux(:,:)

    ! Input fields
    real(r_def), allocatable :: exner_w3(:)
    real(r_def), allocatable :: exner_wtheta(:)
    real(r_def), allocatable :: rho_wtheta(:)
    real(r_def), allocatable :: theta_wtheta(:)
    real(r_def), allocatable :: theta_w3(:)
    real(r_def), allocatable :: dz_wtheta(:)
    real(r_def), allocatable :: temperature_wtheta(:)
    real(r_def), allocatable :: moist_mass_fac(:)

    ! Output fields and expected results fields
    real(r_def), allocatable :: d_mass_wtheta(:), d_mass_wtheta_answer(:)
    real(r_def), allocatable :: layer_heat_capacity_wtheta(:), layer_heat_capacity_wtheta_answer(:)
    real(r_def), allocatable :: t_layer_boundaries(:), t_layer_boundaries_answer(:)

    integer(i_def) :: cell
    real(r_def), parameter :: tol = 1E-08_r_def

    ! Set up dofmap and field dimensions
    nlayers = 7

    call get_wtheta_m3x3_q3x3x3_size( ndf_wtheta, undf_wtheta, cells_wtheta,   &
                                      dim_space_wtheta, dim_space_diff_wtheta, &
                                      nqp_h_wtheta, nqp_v_wtheta, nlayers)

    call get_w3_m3x3_q3x3x3_size( ndf_w3, undf_w3, cells_w3,       &
                                  dim_space_w3, dim_space_diff_w3, &
                                  nqp_h_w3, nqp_v_w3, nlayers)

    call get_w3_m3x3_q3x3x3_size( ndf_flux, undf_flux, cells_flux,       &
                                  dim_space_flux, dim_space_diff_flux, &
                                  nqp_h_flux, nqp_v_flux, nlayers+1)


    call get_w3_m3x3_dofmap(map_w3, nlayers)
    call get_wtheta_m3x3_dofmap(map_wtheta, nlayers)
    call get_w3_m3x3_dofmap(map_flux, nlayers+1)


    ! Allocate the fields
    allocate(exner_w3(1:undf_w3))
    allocate(exner_wtheta(1:undf_wtheta))
    allocate(rho_wtheta(1:undf_wtheta))
    allocate(theta_wtheta(1:undf_wtheta))
    allocate(theta_w3(1:undf_w3))
    allocate(dz_wtheta(1:undf_wtheta))
    allocate(temperature_wtheta(1:undf_wtheta))
    allocate(moist_mass_fac(1:undf_wtheta))
    allocate(d_mass_wtheta(1:undf_wtheta))
    allocate(layer_heat_capacity_wtheta(1:undf_wtheta))
    allocate(t_layer_boundaries(1:undf_flux))

    ! Allocate the expected results fields
    allocate(d_mass_wtheta_answer(1:undf_wtheta))
    allocate(layer_heat_capacity_wtheta_answer(1:undf_wtheta))
    allocate(t_layer_boundaries_answer(1:undf_flux))

    ! Set up input fields
    exner_w3 = (/ &
    0.980226587516_r_def,0.912603821090_r_def,0.806594638135_r_def,0.664819293568_r_def,0.486376345906_r_def,0.262351027019_r_def,0.041414370423_r_def,&
    0.972304974452_r_def,0.903317670180_r_def,0.794263113760_r_def,0.649387629836_r_def,0.485611718436_r_def,0.257662163448_r_def,0.041417776659_r_def,&
    0.971832064752_r_def,0.901397239704_r_def,0.789491345969_r_def,0.646415151989_r_def,0.484729395979_r_def,0.257561485285_r_def,0.041020227334_r_def,&
    0.968608589780_r_def,0.898373380972_r_def,0.787039758307_r_def,0.646192918458_r_def,0.484727696453_r_def,0.258184628681_r_def,0.040903339580_r_def,&
    0.959732097734_r_def,0.893923243856_r_def,0.787406242373_r_def,0.649465562569_r_def,0.485872967659_r_def,0.259043693875_r_def,0.040719853625_r_def,&
    0.955311555978_r_def,0.891782584208_r_def,0.789728780156_r_def,0.656345315531_r_def,0.487885903135_r_def,0.260595467994_r_def,0.040845600114_r_def,&
    0.982886211960_r_def,0.915455823811_r_def,0.810156366315_r_def,0.667844238503_r_def,0.489721624678_r_def,0.263843619904_r_def,0.041314969854_r_def,&
    0.982222743288_r_def,0.914737984373_r_def,0.809189949162_r_def,0.666600545052_r_def,0.487922340814_r_def,0.263831139809_r_def,0.041608759533_r_def,&
    0.981676448942_r_def,0.914068674554_r_def,0.808314225779_r_def,0.665520748188_r_def,0.486649096639_r_def,0.263572300533_r_def,0.041860705778_r_def &
    /)

    exner_wtheta = (/ &
    1.00453166909987_r_def,0.98255534262152_r_def,0.91699251467081_r_def,0.81279660064794_r_def,0.67293133272153_r_def,0.49622840693386_r_def,0.27511884394180_r_def,0.05020509976646_r_def,&
    1.00173848883725_r_def,0.97975887515138_r_def,0.91413632434428_r_def,0.80922798756483_r_def,0.66801326217946_r_def,0.49339175188866_r_def,0.27438353954087_r_def,0.05038450453863_r_def,&
    1.00086499964211_r_def,0.97883959891464_r_def,0.91308526543054_r_def,0.80765072394438_r_def,0.66542677983613_r_def,0.49224637292720_r_def,0.27397739555644_r_def,0.05021728644908_r_def,&
    1.00199644503675_r_def,0.97972497237134_r_def,0.91357219381064_r_def,0.80766843826923_r_def,0.66468200562647_r_def,0.49242450670892_r_def,0.27333450441727_r_def,0.05002574679192_r_def,&
    0.99929574767233_r_def,0.97735349436685_r_def,0.91203474142864_r_def,0.80674246146697_r_def,0.66395919811093_r_def,0.49334085031874_r_def,0.27302077132731_r_def,0.05006969428943_r_def,&
    0.99300848256090_r_def,0.97159098037611_r_def,0.90750129653628_r_def,0.80394735071791_r_def,0.66219120065528_r_def,0.49449067165570_r_def,0.27252647546566_r_def,0.05005708517199_r_def,&
    0.99418177645046_r_def,0.97251043636276_r_def,0.90807962498777_r_def,0.80340283864977_r_def,0.66008646608123_r_def,0.49536746700306_r_def,0.27214506923648_r_def,0.05000972470844_r_def,&
    0.99684797974261_r_def,0.97465961034499_r_def,0.90785137923060_r_def,0.80066102695359_r_def,0.65728417460235_r_def,0.49504236912185_r_def,0.27172145401105_r_def,0.05020628974263_r_def,&
    0.99671448817810_r_def,0.97421915033527_r_def,0.90604597941979_r_def,0.79605807944551_r_def,0.65393487589611_r_def,0.49418382532426_r_def,0.27156872106414_r_def,0.04997340973073_r_def &
    /)

    theta_wtheta = (/ &
    290.94625263546800_r_def,291.48367321516900_r_def,303.30717674338200_r_def,319.64777413706000_r_def,327.93017906458200_r_def,416.97219661014900_r_def,856.11926273516000_r_def,4363.87910564705000_r_def,&
    290.93694816378100_r_def,291.59853447347900_r_def,302.09760598275500_r_def,316.92821479518600_r_def,324.75017902399600_r_def,422.98660118786600_r_def,850.17933837473400_r_def,4361.87417310947000_r_def,&
    290.13260092834400_r_def,291.29986072244100_r_def,299.94701360944200_r_def,315.14187878009400_r_def,322.56854356678300_r_def,427.92762358395700_r_def,829.22479122571400_r_def,4415.45990106824000_r_def,&
    286.52567100690500_r_def,288.63653144435700_r_def,297.68321396648100_r_def,313.95344141442300_r_def,321.99480671229500_r_def,432.43532072540500_r_def,806.41112521020300_r_def,4402.60489439269000_r_def,&
    286.24303699757700_r_def,288.59960659597000_r_def,297.18467127113400_r_def,311.68362279877700_r_def,321.27809094292900_r_def,437.32313166213200_r_def,789.40385975358000_r_def,4421.29288001261000_r_def,&
    286.61099134998400_r_def,289.31756533354700_r_def,299.39872142486600_r_def,309.44849766575600_r_def,319.64871765413000_r_def,442.45665942708100_r_def,780.74222788113800_r_def,4396.75937253016000_r_def,&
    284.20684434366400_r_def,285.94557130988000_r_def,297.30167283514900_r_def,304.81667130727100_r_def,322.99714653871200_r_def,439.71050527401900_r_def,776.19435364688700_r_def,4365.73082485589000_r_def,&
    280.71118240372800_r_def,280.81655058291800_r_def,286.11731715363600_r_def,303.79972440557100_r_def,333.01337463799200_r_def,435.62593805742600_r_def,777.64608641828400_r_def,4364.54141264416000_r_def,&
    278.42688907025200_r_def,278.53704430490800_r_def,280.29178875832900_r_def,296.89424686806800_r_def,350.28082591928800_r_def,434.52501495200900_r_def,780.48558520066900_r_def,4284.47763218917000_r_def &
    /)

    theta_w3 = (/ &
    291.708533443875_r_def,304.297015763628_r_def,320.404855531808_r_def,328.036118629529_r_def,424.743893707652_r_def,891.582088286074_r_def,5037.449530300880_r_def,&
    291.795562384844_r_def,302.729849555696_r_def,317.641137618862_r_def,325.350782665526_r_def,431.029491181991_r_def,892.636361459074_r_def,5008.704373902060_r_def,&
    291.531615758877_r_def,300.677029991086_r_def,315.983879842544_r_def,323.343617927638_r_def,437.600747646651_r_def,879.471050803523_r_def,5039.115328225920_r_def,&
    289.257755869817_r_def,298.731282389023_r_def,314.728366759445_r_def,323.368089850727_r_def,442.000215023754_r_def,860.906885871471_r_def,5073.428991722930_r_def,&
    288.938150467532_r_def,297.381512524974_r_def,312.255707069711_r_def,322.622584457335_r_def,447.823556481041_r_def,841.443919007942_r_def,5052.050663271340_r_def,&
    289.355092206049_r_def,299.921570135103_r_def,310.122698597775_r_def,321.886539065099_r_def,450.263400530359_r_def,831.946225725650_r_def,5021.980027285390_r_def,&
    286.227321651563_r_def,297.720223678128_r_def,305.227220963883_r_def,326.521107337042_r_def,445.716133769610_r_def,828.701759826497_r_def,5071.421808086690_r_def,&
    280.816550582918_r_def,287.020984263012_r_def,304.242977260155_r_def,337.975164069991_r_def,441.580590936904_r_def,830.595814023215_r_def,5028.281709226450_r_def,&
    278.541746232636_r_def,281.127192267224_r_def,298.035861183837_r_def,355.367721068474_r_def,441.344867157689_r_def,833.207607339506_r_def,4976.867089739300_r_def &
    /)
    rho_wtheta = (/ &
    1.19038370633384_r_def,1.12644992278254_r_def,0.92159887963622_r_def,0.64909560563380_r_def,0.39495025190304_r_def,0.14519793263844_r_def,0.01659254193908_r_def,0.00004969075003_r_def,&
    1.18333159990702_r_def,1.11883530861652_r_def,0.91697794693056_r_def,0.64710866564960_r_def,0.39133117090749_r_def,0.14101732381790_r_def,0.01655942622658_r_def,0.00004966157140_r_def,&
    1.19038370633384_r_def,1.12644992278254_r_def,0.92159887963622_r_def,0.64909560563380_r_def,0.39495025190304_r_def,0.14519793263844_r_def,0.01659254193908_r_def,0.00004969075003_r_def,&
    1.18333159990702_r_def,1.11883530861652_r_def,0.91697794693056_r_def,0.64710866564960_r_def,0.39133117090749_r_def,0.14101732381790_r_def,0.01655942622658_r_def,0.00004966157140_r_def,&
    1.18406772201449_r_def,1.11740575586039_r_def,0.91808319921992_r_def,0.64701113159382_r_def,0.39005605031508_r_def,0.13854701866294_r_def,0.01677916736870_r_def,0.00004848132853_r_def,&
    1.20660028366959_r_def,1.13413304361924_r_def,0.92714470845984_r_def,0.65041284980086_r_def,0.38980322468449_r_def,0.13731693130990_r_def,0.01709519187886_r_def,0.00004804879013_r_def,&
    1.21095295030077_r_def,1.13753618361082_r_def,0.93487211605929_r_def,0.65635577450660_r_def,0.39035574107431_r_def,0.13636433036292_r_def,0.01735889605438_r_def,0.00004772619281_r_def,&
    1.12886321980649_r_def,1.06221563386957_r_def,0.87553253512945_r_def,0.63584249447069_r_def,0.38429858668093_r_def,0.13576642971164_r_def,0.01745425889206_r_def,0.00004806168545_r_def,&
    1.22020357582255_r_def,1.14880902096142_r_def,0.93424785213067_r_def,0.66793663926059_r_def,0.38287352307309_r_def,0.13709406481582_r_def,0.01744975140650_r_def,0.00004829772890_r_def &
    /)
    dz_wtheta = (/ &
    9.99999084315741_r_def,133.33188249062300_r_def,266.66779288952400_r_def,399.99975911498700_r_def,537.75180772696700_r_def,816.05998241319700_r_def,2114.88800000004000_r_def,7406.38799999980000_r_def,&
    9.99983307887566_r_def,133.32985793326300_r_def,266.66422460387500_r_def,399.99560893258000_r_def,537.74849507354200_r_def,816.05967941105300_r_def,2114.88800000015000_r_def,7406.38799999980000_r_def,&
    9.99961957051046_r_def,133.32711802606000_r_def,266.65939551319200_r_def,399.98999233983900_r_def,537.74401193934900_r_def,816.05926934736300_r_def,2114.88800000027000_r_def,7406.38799999992000_r_def,&
    9.98540878515366_r_def,133.14475384892400_r_def,266.33797839069000_r_def,399.61616023810500_r_def,537.44562116083900_r_def,816.03197610694000_r_def,2114.88800000027000_r_def,7406.38800000015000_r_def,&
    9.83719855305941_r_def,131.24280147066400_r_def,262.98578460606600_r_def,395.71730868177500_r_def,534.33357876397000_r_def,815.74732347530500_r_def,2114.88800000027000_r_def,7406.38800000004000_r_def,&
    9.63050154079792_r_def,128.59029989654600_r_def,258.31074679123900_r_def,390.27989078970000_r_def,529.99346097216200_r_def,815.35034111038800_r_def,2114.88800000027000_r_def,7406.38799999969000_r_def,&
    9.61453895174054_r_def,128.38545517184700_r_def,257.94970767123800_r_def,389.85997534762800_r_def,529.65828671907400_r_def,815.31968335542500_r_def,2114.88800000027000_r_def,7406.38799999957000_r_def,&
    9.68870508730618_r_def,129.33721441286600_r_def,259.62718469366200_r_def,391.81100632048300_r_def,531.21558917498300_r_def,815.46212686522600_r_def,2114.88800000027000_r_def,7406.38799999992000_r_def,&
    9.73426949807694_r_def,129.92193341876400_r_def,260.65775277721600_r_def,393.00963391603600_r_def,532.17232729174400_r_def,815.54963789110500_r_def,2114.88800000027000_r_def,7406.38800000015000_r_def &
    /)

    temperature_wtheta = (/ &
    0.00000000000000_r_def,   286.39883654976256_r_def,   278.13041398143469_r_def,   259.80861516500590_r_def,   220.67448392958613_r_def,   206.91344560363177_r_def,   235.53455354104881_r_def,   219.08897830634669_r_def, &
    0.00000000000000_r_def,   285.69625397763230_r_def,   276.15839308026261_r_def,   256.46719272239716_r_def,   216.93743326585172_r_def,   208.69810112253617_r_def,   233.27521599456668_r_def,   219.77085419978903_r_def, &
    0.00000000000000_r_def,   285.13583712400214_r_def,   273.87721065180085_r_def,   254.52457108356430_r_def,   214.64575000815603_r_def,   210.64580932361787_r_def,   227.18885172428418_r_def,   221.73241458622215_r_def, &
    0.00000000000000_r_def,   282.78441361616206_r_def,   271.95511876167438_r_def,   253.57027953564830_r_def,   214.02416551566421_r_def,   212.94176048652389_r_def,   220.41998634114861_r_def,   220.24359948762140_r_def, &
    0.00000000000000_r_def,   282.06384214258287_r_def,   271.04273878355889_r_def,   251.44842292749126_r_def,   213.31553608739341_r_def,   215.74935974921391_r_def,   215.52365558418569_r_def,   221.37278371273715_r_def, &
    0.00000000000000_r_def,   281.09834196936572_r_def,   271.70471460606677_r_def,   248.78028420786723_r_def,   211.66856817494590_r_def,   218.79069852791872_r_def,   212.77293116463807_r_def,   220.08894569634867_r_def, &
    0.00000000000000_r_def,   278.08504397681099_r_def,   269.97358536407410_r_def,   244.89058745362672_r_def,   213.20603074784231_r_def,   217.81828185513950_r_def,   211.23745620946283_r_def,   218.32899913990514_r_def, &
    0.00000000000000_r_def,   273.70056100839975_r_def,   259.75199948288355_r_def,   243.24059045187278_r_def,   218.88442438397396_r_def,   215.65330671892843_r_def,   211.30311615420760_r_def,   219.12743076789047_r_def, &
    0.00000000000000_r_def,   271.35612463620419_r_def,   253.95723731767976_r_def,   236.34506555313783_r_def,   229.06085339566562_r_def,   214.73524443165661_r_def,   211.95547074782371_r_def,   214.10995107971758_r_def  &
    /)

    moist_mass_fac = 1.0_r_def

    ! Set all output fields to 0.0
    d_mass_wtheta = 0.0_r_def
    layer_heat_capacity_wtheta = 0.0_r_def
    t_layer_boundaries = 0.0_r_def

    ! Call kernel code on all columns
    do cell=1_i_def,cells_wtheta
      call set_thermodynamic_code( nlayers, &
                                   exner_w3, &
                                   exner_wtheta, &
                                   theta_wtheta, &
                                   theta_w3, &
                                   rho_wtheta, &
                                   dz_wtheta, &
                                   temperature_wtheta, &
                                   moist_mass_fac, &
                                   d_mass_wtheta, &
                                   layer_heat_capacity_wtheta, &
                                   t_layer_boundaries, &
                                   p_zero, &
                                   kappa, &
                                   gravity, &
                                   cp, &
                                   ndf_w3, &
                                   undf_w3, &
                                   map_w3(:,cell), &
                                   ndf_wtheta, &
                                   undf_wtheta, &
                                   map_wtheta(:,cell), &
                                   ndf_flux, &
                                   undf_flux, &
                                   map_flux(:,cell) )
    end do

    ! Set up expected fields

    d_mass_wtheta_answer = (/ &
    0.000000000000000E+000_r_def,   161.456177649114_r_def,   245.760739162049_r_def,   259.638085896117_r_def,   212.385211923081_r_def,   118.490222355358_r_def,   35.0913678364577_r_def,   0.146873138741414_r_def, &
    0.000000000000000E+000_r_def,   160.362319077477_r_def,   244.525213197091_r_def,   258.840624762061_r_def,   210.437748230870_r_def,   115.078552066240_r_def,   35.0213318134818_r_def,   0.146915436682402_r_def, &
    0.000000000000000E+000_r_def,   161.450392498330_r_def,   245.75300014942_r_def,    259.631746325287_r_def,   212.382132974797_r_def,   118.490118819673_r_def,   35.0913678364615_r_def,   0.142037222551378_r_def, &
    0.000000000000000E+000_r_def,   160.139079683031_r_def,   244.226052614331_r_def,   258.595080223697_r_def,   210.319224227974_r_def,   115.074645420433_r_def,   35.0213318134838_r_def,   0.140625226536259_r_def, &
    0.000000000000000E+000_r_def,   157.643604063293_r_def,   241.442830480498_r_def,   256.033503681456_r_def,   208.420045283396_r_def,   113.019359649776_r_def,   35.4860597180597_r_def,   0.138428995029220_r_def, &
    0.000000000000000E+000_r_def,   156.760778225625_r_def,   239.491442025807_r_def,   253.843055988497_r_def,   206.593160148642_r_def,   111.961406783759_r_def,   36.1544161623031_r_def,   0.139931451063549_r_def, &
    0.000000000000000E+000_r_def,   156.979986653661_r_def,   241.149989047486_r_def,   255.886846068416_r_def,   206.755153028373_r_def,   111.180522652471_r_def,   36.7121209586603_r_def,   0.145642629868449_r_def, &
    0.000000000000000E+000_r_def,   147.675505206175_r_def,   227.312047203364_r_def,   249.130087619887_r_def,   204.145400142824_r_def,   110.712381529552_r_def,   36.9138026797157_r_def,   0.149300975619410_r_def, &
    0.000000000000000E+000_r_def,   160.438305744085_r_def,   243.518945673321_r_def,   262.505534074912_r_def,   203.754693832196_r_def,   111.807014917562_r_def,   36.9042698525947_r_def,   0.152490165728063_r_def  &
    /)
    layer_heat_capacity_wtheta_answer = (/ &
    0.000000000000000E+000_r_def,   162263.458537359_r_def,   246989.542857859_r_def,   260936.276325597_r_def,   213447.137982696_r_def,   119082.673467135_r_def,   35266.8246756400_r_def,   147.607504435121_r_def, &
    0.000000000000000E+000_r_def,   161164.130672864_r_def,   245747.839263077_r_def,   260134.827885871_r_def,   211489.936972024_r_def,   115653.944826571_r_def,   35196.4384725492_r_def,   147.650013865814_r_def, &
    0.000000000000000E+000_r_def,   162257.644460822_r_def,   246981.765150177_r_def,   260929.905056913_r_def,   213444.043639671_r_def,   119082.569413771_r_def,   35266.8246756438_r_def,   142.747408664135_r_def, &
    0.000000000000000E+000_r_def,   160939.775081446_r_def,   245447.182877402_r_def,   259888.055624815_r_def,   211370.820349114_r_def,   115650.018647535_r_def,   35196.4384725512_r_def,   141.328352668941_r_def, &
    0.000000000000000E+000_r_def,   158431.822083609_r_def,   242650.044632900_r_def,   257313.671199864_r_def,   209462.145509813_r_def,   113584.456448025_r_def,   35663.4900166500_r_def,   139.121140004366_r_def, &
    0.000000000000000E+000_r_def,   157544.582116754_r_def,   240688.899235936_r_def,   255112.271268440_r_def,   207626.125949385_r_def,   112521.213817677_r_def,   36335.1882431146_r_def,   140.631108318867_r_def, &
    0.000000000000000E+000_r_def,   157764.886586930_r_def,   242355.738992723_r_def,   257166.280298758_r_def,   207788.928793515_r_def,   111736.425265733_r_def,   36895.6815634536_r_def,   146.370843017791_r_def, &
    0.000000000000000E+000_r_def,   148413.882732206_r_def,   228448.607439381_r_def,   250375.738057987_r_def,   205166.127143538_r_def,   111265.943437200_r_def,   37098.3716931143_r_def,   150.047480497507_r_def, &
    0.000000000000000E+000_r_def,   161240.497272806_r_def,   244736.540401688_r_def,   263818.061745286_r_def,   204773.467301357_r_def,   112366.049992149_r_def,   37088.7912018577_r_def,   153.252616556703_r_def  &
    /)
    t_layer_boundaries_answer = (/ &
    292.264724778259_r_def,   277.702619332171_r_def,   258.436838504376_r_def,   218.084740652072_r_def,   206.585382967414_r_def,   233.907476533596_r_def,   208.622800835048_r_def,   219.088978306347_r_def, &
    291.442738800507_r_def,   273.461222394593_r_def,   252.290639023426_r_def,   211.278773620453_r_def,   209.312971909481_r_def,   229.998616065896_r_def,   207.449399109232_r_def,   219.770854199789_r_def, &
    290.383565524311_r_def,   271.029444876362_r_def,   249.466538601397_r_def,   209.014213927367_r_def,   212.117946086720_r_def,   226.517870110115_r_def,   206.705656326071_r_def,   221.732414586222_r_def, &
    287.097703760688_r_def,   268.372232161928_r_def,   247.703737706710_r_def,   208.958169716830_r_def,   214.249746060195_r_def,   222.272924657642_r_def,   207.520188883460_r_def,   220.243599487621_r_def, &
    286.041449672492_r_def,   265.836246339128_r_def,   245.872092963285_r_def,   209.532258312048_r_def,   217.585360375051_r_def,   217.970740968474_r_def,   205.718763514493_r_def,   221.372783712737_r_def, &
    284.607145605723_r_def,   267.464832874803_r_def,   244.912820462308_r_def,   211.268722047864_r_def,   219.677165816390_r_def,   216.801416038818_r_def,   205.125787974994_r_def,   220.088945696349_r_def, &
    282.553265388963_r_def,   272.549712632456_r_def,   247.281776236525_r_def,   218.065240284663_r_def,   218.276829174850_r_def,   218.647672133438_r_def,   209.525639118020_r_def,   218.328999139905_r_def, &
    279.826375070316_r_def,   262.548996617502_r_def,   246.190359302040_r_def,   225.294428583095_r_def,   215.457035587964_r_def,   219.137040334329_r_def,   209.220564503386_r_def,   219.127430767890_r_def, &
    277.512114234677_r_def,   256.969560016789_r_def,   240.906626387191_r_def,   236.504591607355_r_def,   214.780080908549_r_def,   219.610445888070_r_def,   208.335168939788_r_def,   214.109951079718_r_def  &
    /)

    ! Compare kernel output with expected output based on a tolerance
    @assertEqual(d_mass_wtheta, d_mass_wtheta_answer, tol)
    @assertEqual(layer_heat_capacity_wtheta, layer_heat_capacity_wtheta_answer, tol)
    @assertEqual(t_layer_boundaries, t_layer_boundaries_answer, tol)

    deallocate(map_w3)
    deallocate(map_wtheta)
    deallocate(map_flux)
    deallocate(exner_w3)
    deallocate(exner_wtheta)
    deallocate(rho_wtheta)
    deallocate(theta_wtheta)
    deallocate(theta_w3)
    deallocate(dz_wtheta)
    deallocate(temperature_wtheta)
    deallocate(moist_mass_fac)
    deallocate(d_mass_wtheta)
    deallocate(layer_heat_capacity_wtheta)
    deallocate(t_layer_boundaries)
    deallocate(d_mass_wtheta_answer)
    deallocate(layer_heat_capacity_wtheta_answer)
    deallocate(t_layer_boundaries_answer)

  end subroutine test_set_thermodynamic

end module set_thermodynamic_kernel_mod_test
