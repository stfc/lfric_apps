!-----------------------------------------------------------------------------
! (C) Crown copyright 2023 Met Office. All rights reserved.
! The file LICENCE, distributed with this code, contains details of the terms
! under which the code may be used.
!-----------------------------------------------------------------------------
!> Test easyaerosol_convdiag_kernel
!>

module easyaerosol_convdiag_kernel_mod_test

  use funit
  use constants_mod,                   only : r_def, i_def
  use easyaerosol_convdiag_kernel_mod, only : easyaerosol_convdiag_code

  implicit none

  private
  public :: test_easyaerosol_convdiag

  @TestCase
  type, extends(TestCase), public  :: easyaerosol_test_type
    private
    real(kind=r_def), allocatable :: aer_prop(:),               &
                                     aer_diag(:),               &
                                     aer_mix_ratio(:),          &
                                     rho_wtheta(:),             &
                                     answer_diag(:)

  contains
    procedure setUp
    procedure tearDown
    procedure test_easyaerosol_convdiag

  end type easyaerosol_test_type

  integer(kind=i_def), parameter :: nlayers       = 2_i_def
  integer(kind=i_def), parameter :: n_band        = 2_i_def
  integer(kind=i_def), parameter :: n_radaer_mode = 1_i_def
  integer(kind=i_def), parameter :: mode_dimen    =  n_radaer_mode + 1_i_def
  integer(kind=i_def), parameter :: ndf           = 2_i_def
  integer(kind=i_def), parameter :: map(2)        = (/1_i_def, -999_i_def /)
  integer(kind=i_def), parameter :: aer_arr_len   = (nlayers + 1) * n_band * (n_radaer_mode + 1)
  integer(kind=i_def), parameter :: mmr_arr_len   = (nlayers + 1) * (n_radaer_mode + 1)
  integer(kind=i_def), parameter :: rho_arr_len   =  nlayers + 1
  integer(kind=i_def), parameter :: easy_arr_len  = (nlayers + 1) * n_band

contains

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  @before
  subroutine setUp( this )

    implicit none

    class(easyaerosol_test_type), intent(inout) :: this

    allocate ( this%aer_prop      (aer_arr_len),                &
               this%aer_diag      (aer_arr_len),                &
               this%aer_mix_ratio (mmr_arr_len),                &
               this%rho_wtheta    (rho_arr_len),                &
               this%answer_diag   (easy_arr_len) )

  end subroutine setUp

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  @after
  subroutine tearDown( this )

    implicit none

    class(easyaerosol_test_type), intent(inout) :: this

    deallocate( this%aer_prop,                                  &
                this%aer_diag,                                  &
                this%aer_mix_ratio,                             &
                this%rho_wtheta,                                &
                this%answer_diag )

  end subroutine tearDown


  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  @test
  subroutine test_easyaerosol_convdiag ( this )

    implicit none

    class(easyaerosol_test_type), intent(inout) :: this

    this%aer_prop      = (/1.0_r_def, 2.0_r_def, 3.0_r_def, 4.0_r_def, 5.0_r_def, 6.0_r_def,       &
                           7.0_r_def, 8.0_r_def, 9.0_r_def, 10.0_r_def, 11.0_r_def, 12.0_r_def /)
    this%aer_mix_ratio = (/1000.0_r_def, 100.0_r_def, 1.00_r_def, 1.0_r_def, 1.0_r_def, 1.0_r_def/)
    this%rho_wtheta    = (/   2.0_r_def,   1.0_r_def,  0.5_r_def /)

    ! Create the answers
    this%answer_diag   = (/   0.0_r_def, 200.0_r_def, 1.5_r_def,  0.0_r_def,  5.0_r_def, 3.0_r_def,   &
                              0.0_r_def, 800.0_r_def, 4.5_r_def,  0.0_r_def, 11.0_r_def, 6.0_r_def /)

    call easyaerosol_convdiag_code( nlayers,                                   &
                                    n_band,                                    &
                                    mode_dimen,                                &
                                    this%aer_prop,                             &
                                    this%aer_diag,                             &
                                    this%aer_mix_ratio,                        &
                                    this%rho_wtheta,                           &
                                    ndf, aer_arr_len, map,                     &
                                    ndf, aer_arr_len, map,                     &
                                    ndf, mmr_arr_len, map,                     &
                                    ndf, rho_arr_len, map )

    @assertEqual( this%answer_diag, this%aer_diag )

  end subroutine test_easyaerosol_convdiag

end module easyaerosol_convdiag_kernel_mod_test
