!-----------------------------------------------------------------------------
! (C) Crown copyright 2023 Met Office. All rights reserved.
! The file LICENCE, distributed with this code, contains details of the terms
! under which the code may be used.
!-----------------------------------------------------------------------------
!> Test easyaerosol_aer_kernel
!>

module easyaerosol_aer_kernel_mod_test

  use funit
  use constants_mod,                   only : r_def, i_def
  use easyaerosol_aer_kernel_mod,      only : easyaerosol_aer_code

  implicit none

  private
  public :: test_easyaerosol_aer

  @TestCase
  type, extends(TestCase), public  :: easyaerosol_test_type
    private
    real(kind=r_def), allocatable :: aer_mix_ratio(:), answer_mmr(:)

  contains
    procedure setUp
    procedure tearDown
    procedure test_easyaerosol_aer

  end type easyaerosol_test_type

  integer(kind=i_def), parameter :: nlayers       = 2_i_def
  integer(kind=i_def), parameter :: ndf           = 2_i_def
  integer(kind=i_def), parameter :: map(2)        = (/1_i_def, -999_i_def /)
  integer(kind=i_def), parameter :: n_radaer_mode = 1_i_def
  integer(kind=i_def), parameter :: mode_dimen    =  n_radaer_mode + 1_i_def
  integer(kind=i_def), parameter :: mmr_arr_len   = (nlayers + 1) * (n_radaer_mode + 1)

contains

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  @before
  subroutine setUp( this )

    implicit none

    class(easyaerosol_test_type), intent(inout) :: this

    allocate ( this%aer_mix_ratio (mmr_arr_len),                &
               this%answer_mmr    (mmr_arr_len) )

  end subroutine setUp

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  @after
  subroutine tearDown( this )

    implicit none

    class(easyaerosol_test_type), intent(inout) :: this

    deallocate( this%aer_mix_ratio,                             &
                this%answer_mmr)

  end subroutine tearDown

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  @test
  subroutine test_easyaerosol_aer ( this )

    use easyaerosol_aer_kernel_mod, only : easyaerosol_aer_code

    implicit none

    class(easyaerosol_test_type), intent(inout) :: this

    this%aer_mix_ratio = (/7.0_r_def, 6.0_r_def, 5.0_r_def, -3.0_r_def, -4.0_r_def, -5.0_r_def /)
    this%answer_mmr    = (/7.0_r_def, 6.0_r_def, 5.0_r_def,  0.0_r_def,  1.0_r_def,  1.0_r_def /)

    call easyaerosol_aer_code( nlayers,                                        &
                               mode_dimen,                                     &
                               this%aer_mix_ratio,                             &
                               ndf, mmr_arr_len, map )

    @assertEqual( this%answer_mmr, this%aer_mix_ratio )

  end subroutine test_easyaerosol_aer

end module easyaerosol_aer_kernel_mod_test
