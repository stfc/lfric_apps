!-----------------------------------------------------------------------------
! (C) Crown copyright 2024 Met Office. All rights reserved.
! The file LICENCE, distributed with this code, contains details of the terms
! under which the code may be used.
!-----------------------------------------------------------------------------
!> Test the Photolysis pseudo profile generation kernel
!>
module pseudo_photol_kernel_mod_test

  use funit
  use constants_mod,                       only : r_def, i_def
  use get_unit_test_m3x3_dofmap_mod,       only : get_wtheta_m3x3_dofmap,      &
                                                  get_w3_m3x3_dofmap
  use get_unit_test_m3x3_q3x3x3_sizes_mod, only : get_wtheta_m3x3_q3x3x3_size, &
                                                  get_w3_m3x3_q3x3x3_size

  implicit none

contains

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  @Test
  subroutine test_pseudo_photol()

    use pseudo_photol_kernel_mod, only: pseudo_photol_code

    implicit none

    integer(i_def) :: nlayers
    integer(i_def) :: ndf_wtheta, ndf_2d
    integer(i_def) :: undf_wtheta, undf_2d
    integer(i_def) :: cells
    integer(i_def) :: dim_space
    integer(i_def) :: dim_space_diff
    integer(i_def) :: nqp_h
    integer(i_def) :: nqp_v

    integer(i_def), allocatable :: map_wtheta(:,:)
    integer(i_def), allocatable :: map_2d(:,:)

    integer(i_def) :: curr_hour
    integer(i_def) :: curr_minute
    integer(i_def) :: i

    real(r_def), allocatable :: latitude(:)
    real(r_def), allocatable :: longitude(:)
    real(r_def), allocatable :: photol_rates(:)
    real(r_def), allocatable :: answer(:)

    real(r_def), parameter :: tol = 1.0e-09_r_def

    nlayers = 3_i_def  ! For wtheta field (translates to 0->3 =4 levels)

    call get_wtheta_m3x3_q3x3x3_size( ndf_wtheta, undf_wtheta, cells, &
                                      dim_space, dim_space_diff,      &
                                      nqp_h, nqp_v, nlayers)
    call get_wtheta_m3x3_dofmap(map_wtheta, nlayers)

    call get_w3_m3x3_q3x3x3_size( ndf_2d, undf_2d, cells,        &
                                  dim_space, dim_space_diff,     &
                                  nqp_h, nqp_v, 1)
    call get_w3_m3x3_dofmap(map_2d, 1)

    allocate(latitude(1:undf_2d))
    allocate(longitude(1:undf_2d))

    allocate(photol_rates(1:undf_wtheta))
    allocate(answer(1:undf_wtheta))

    ! 'Model' time = UTC, converted to local time in routine based on lat,lon
    curr_hour = 10_i_def
    curr_minute = 30_i_def

    ! Coordinates - radians
    latitude= (/                                                        &
      -1.568519e+00_r_def, -1.064645e+00_r_def, -7.864413e-01_r_def,    &
      -2.441703e-01_r_def,  0.000000e+00_r_def,  2.422505e-01_r_def,    &
       7.864413e-01_r_def,  1.064645e+00_r_def,  1.568519e+00_r_def /)

    longitude= (/                                                       &
      0.000000e+00_r_def,  6.923686e-01_r_def,  1.372869e+00_r_def,     &
      2.094384e+00_r_def,  2.769125e+00_r_def,  3.517693e+00_r_def,     &
      4.252822e+00_r_def,  4.677458e+00_r_def,  6.021355e+00_r_def /)

    ! Loop over cells in the maps (same for w3 and wth)
    do i = 1, cells
      call pseudo_photol_code ( nlayers,                                  &
                                photol_rates,                             &
                                curr_hour, curr_minute,                   &
                                latitude, longitude,                      &
                                ndf_wtheta, undf_wtheta, map_wtheta(:,i), &
                                ndf_2d, undf_2d, map_2d(:,i)              &
                               )
    end do

    ! 3 x 3 x 4 levs = 36 values in field
    answer = (/ 0.0000000000E+00_r_def, 0.9868407581E-03_r_def,  &
                0.1973681516E-02_r_def, 0.2960522274E-02_r_def,  &
                0.0000000000E+00_r_def, 0.1323544216E+00_r_def,  &
                0.2647088433E+00_r_def, 0.3970632649E+00_r_def,  &
                0.0000000000E+00_r_def, 0.1530465707E+00_r_def,  &
                0.3060931413E+00_r_def, 0.4591397120E+00_r_def,  &
                0.0000000000E+00_r_def, 0.0000000000E+00_r_def,  &
                0.0000000000E+00_r_def, 0.0000000000E+00_r_def,  &
                0.0000000000E+00_r_def, 0.0000000000E+00_r_def,  &
                0.0000000000E+00_r_def, 0.0000000000E+00_r_def,  &
                0.0000000000E+00_r_def, 0.0000000000E+00_r_def,  &
                0.0000000000E+00_r_def, 0.0000000000E+00_r_def,  &
                0.0000000000E+00_r_def, 0.0000000000E+00_r_def,  &
                0.0000000000E+00_r_def, 0.0000000000E+00_r_def,  &
                0.0000000000E+00_r_def, 0.0000000000E+00_r_def,  &
                0.0000000000E+00_r_def, 0.0000000000E+00_r_def,  &
                0.0000000000E+00_r_def, 0.8980250899E-03_r_def,  &
                0.1796050180E-02_r_def, 0.2694075270E-02_r_def   &
              /)

    @assertEqual(answer, photol_rates, tol)

    deallocate(map_2d)
    deallocate(map_wtheta)
    deallocate(latitude)
    deallocate(longitude)
    deallocate(photol_rates)
    deallocate(answer)

  end subroutine test_pseudo_photol

end module pseudo_photol_kernel_mod_test
